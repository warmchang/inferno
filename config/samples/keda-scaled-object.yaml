# Example KEDA ScaledObject using WVA desired-replicas metric.
# Requires VariantAutoscaling for sample-deployment (see variantautoscaling-integration.yaml).
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: sample-deployment-scaler
  namespace: llm-d-sim
  labels:
    app: sample-deployment
    scaler: keda-workload-variant-autoscaler
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: sample-deployment
  pollingInterval: 5
  cooldownPeriod: 30
  initialCooldownPeriod: 30
  maxReplicaCount: 10
  fallback:
    failureThreshold: 3
    replicas: 2
    behavior: "currentReplicasIfHigher"
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      name: wva-keda-hpa-sample-deployment
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 0
          policies:
          - type: Percent
            value: 100
            periodSeconds: 30
          - type: Pods
            value: 5
            periodSeconds: 15
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
          - type: Percent
            value: 100
            periodSeconds: 30
          - type: Pods
            value: 5
            periodSeconds: 15
  triggers:
  - type: prometheus
    name: wva-desired-replicas
    metadata:
      serverAddress: https://kube-prometheus-stack-prometheus.workload-variant-autoscaler-monitoring.svc.cluster.local:9090
      query: |
        wva_desired_replicas{
          variant_name="sample-deployment",
          exported_namespace="llm-d-sim"
        }
      threshold: '1'
      activationThreshold: '0'
      metricType: "AverageValue"
      unsafeSsl: "true"
