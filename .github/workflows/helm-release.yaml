name: Release – Docker Image & Publish Helm Chart to GHCR

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.4.1) - for testing without creating a release'
        required: false
        type: string
  push:
    tags:
      - 'v*-test'  # Allow test tags like v0.4.1-test

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------
      # 1. Checkout repo
      # -----------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # For workflow_dispatch with tag, checkout the tag; otherwise use default ref
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag && format('refs/tags/{0}', github.event.inputs.tag) || github.ref }}
          token: ${{ github.token }}
          persist-credentials: true

      # -----------------------------------------
      # 2. Determine version from tag (v0.0.4 → 0.0.4)
      # -----------------------------------------
      - name: Determine version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger - use input tag or default
            RAW_TAG="${{ github.event.inputs.tag }}"
            if [[ -z "$RAW_TAG" ]]; then
              echo "Error: tag input required for workflow_dispatch" >&2
              exit 1
            fi
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Push event - get tag from ref
            RAW_TAG="${GITHUB_REF#refs/tags/}"
          else
            # Release event - get tag from ref
            RAW_TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${RAW_TAG#v}"
          echo "tag=$RAW_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # -----------------------------------------
      # 3. Set up QEMU + Buildx
      # -----------------------------------------
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------
      # 4. Log in to GHCR for Docker push
      # -----------------------------------------
      - name: Docker login GHCR
        run: echo "${{ secrets.CR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.CR_USER }} --password-stdin

      # -----------------------------------------
      # 5. Build and push multi-arch Docker image
      # -----------------------------------------
      - name: Build and push container image
        run: |
          IMAGE="ghcr.io/llm-d/llm-d-workload-variant-autoscaler"
          TAG="${{ steps.version.outputs.tag }}"

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --push \
            --annotation "index:org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
            --annotation "index:org.opencontainers.image.description=Workload Variant Autoscaler (WVA) - GPU-aware autoscaler for LLM inference workloads" \
            --annotation "index:org.opencontainers.image.licenses=Apache-2.0" \
            -t $IMAGE:$TAG \
            -t $IMAGE:latest .

      # -----------------------------------------
      # 6. Patch Helm chart (Chart.yaml + values.yaml)
      # -----------------------------------------
      - name: Update Helm chart files
        run: |
          CHART_DIR="charts/workload-variant-autoscaler"
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          # Chart.yaml updates
          sed -i "s/^version:.*/version: ${VERSION}/"       $CHART_DIR/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${TAG}\"/" $CHART_DIR/Chart.yaml

          # values.yaml—update repository and container tag
          sed -i "s|^    repository:.*|    repository: ghcr.io/llm-d/llm-d-workload-variant-autoscaler|" $CHART_DIR/values.yaml
          sed -i "s/^    tag:.*/    tag: \"${TAG}\"/" $CHART_DIR/values.yaml

          echo "Updated Chart.yaml:"
          cat $CHART_DIR/Chart.yaml

          echo "Updated values.yaml:"
          cat $CHART_DIR/values.yaml

      # -----------------------------------------
      # 7. Install Helm
      # -----------------------------------------
      - name: Install Helm
        env:
          GITHUB_TOKEN: ${{ github.token }}
        uses: azure/setup-helm@v4

      # -----------------------------------------
      # 8. Login to GHCR for chart publishing
      # -----------------------------------------
      - name: Login to GHCR (Helm)
        env:
          GITHUB_TOKEN: ${{ secrets.CR_TOKEN }}
        run: |
          helm registry login ghcr.io \
            --username ${{ secrets.CR_USER }} \
            --password "$GITHUB_TOKEN"
          echo "Helm registry login successful"

      # -----------------------------------------
      # 9. Package Helm chart
      # -----------------------------------------
      - name: Package chart
        run: |
          helm package charts/workload-variant-autoscaler --destination .

      # -----------------------------------------
      # 10. Push chart to GHCR
      # -----------------------------------------
      - name: Push Helm chart
        env:
          GITHUB_TOKEN: ${{ secrets.CR_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHART_FILE="workload-variant-autoscaler-${VERSION}.tgz"

          # Push to org-level path to avoid nested sub-package (slashes in
          # GHCR package names prevent visibility changes via API/UI).
          helm push "$CHART_FILE" \
            oci://ghcr.io/llm-d

      # -----------------------------------------
      # 10b. Ensure Helm chart package is public
      # -----------------------------------------
      - name: Set Helm chart package visibility to public
        env:
          GH_TOKEN: ${{ secrets.CR_TOKEN }}
        run: |
          gh api --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "/orgs/${{ github.repository_owner }}/packages/container/workload-variant-autoscaler" \
            -f visibility='public' || echo "::warning::Could not set chart package to public — may need manual update"

      # -----------------------------------------
      # 11. Commit updated chart files
      # -----------------------------------------
      - name: Commit updated Helm chart files
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Configure Git user to match the person who triggered the release
          # This ensures each person is responsible for their own release commits
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          # Configure remote to use github.token (belongs to the person who triggered workflow)
          git remote set-url origin https://${{ github.token }}@github.com/${{ github.repository }}.git

          # Checkout the default branch (we're in detached HEAD from tag checkout)
          git fetch origin
          DEFAULT_BRANCH=$(git remote show origin | grep "HEAD branch" | cut -d' ' -f5 || echo "main")
          git checkout $DEFAULT_BRANCH
          git pull origin $DEFAULT_BRANCH
          
          # Stage changes
          git add charts/workload-variant-autoscaler/Chart.yaml
          git add charts/workload-variant-autoscaler/values.yaml

          # Commit with message showing who created the release
          COMMIT_MSG="Release ${{ steps.version.outputs.tag }}: update Chart.yaml and values.yaml"
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          
          # Push directly to main (bypass enabled via role-based permissions)
          # The person who triggered the workflow must have Write/Maintain role with bypass
          git push origin $DEFAULT_BRANCH || echo "Push failed - ensure your role has bypass permissions"
