{{- if .Values.controller.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "workload-variant-autoscaler.fullname" . }}-variantautoscaling-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "workload-variant-autoscaler.labels" . | nindent 4 }}
{{- if and .Values.wva.configMap .Values.wva.configMap.immutable }}
immutable: true
{{- end }}
data:
  # The main configuration is stored as a single YAML file (config.yaml) that is
  # volume-mounted into the controller container at /etc/wva/config.yaml.
  #
  # Precedence: CLI flags > environment variables > config file > defaults
  #
  # For more information see:
  # https://github.com/llm-d/llm-d-workload-variant-autoscaler/blob/main/docs/user-guide/configuration.md
  config.yaml: |
    # Prometheus Configuration (REQUIRED)
    # Base URL for Prometheus API (must use HTTPS).
    PROMETHEUS_BASE_URL: {{ .Values.wva.prometheus.baseURL | quote }}
    # Filesystem path to the CA certificate used to verify Prometheus TLS cert.
    PROMETHEUS_CA_CERT_PATH: {{ .Values.wva.prometheus.tls.caCertPath | default "/etc/ssl/certs/prometheus-ca.crt" | quote }}
    # Whether to skip TLS certificate verification when connecting to Prometheus.
    PROMETHEUS_TLS_INSECURE_SKIP_VERIFY: {{ if and .Values.wva.prometheus.tls (hasKey .Values.wva.prometheus.tls "insecureSkipVerify") }}{{ .Values.wva.prometheus.tls.insecureSkipVerify | quote }}{{ else }}"true"{{ end }}

    # Optimization
    # Global optimization loop interval for autoscaling decisions.
    GLOBAL_OPT_INTERVAL: {{ .Values.wva.reconcileInterval | quote }}

    # Feature Flags
    # Enables scale-to-zero behavior across managed workloads.
    WVA_SCALE_TO_ZERO: {{ .Values.wva.scaleToZero | default "false" | quote }}

    # Prometheus Metrics Cache
    # Time-to-live for cached Prometheus metric responses.
    PROMETHEUS_METRICS_CACHE_TTL: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.ttl | default "30s" | quote }}{{ else }}"30s"{{ end }}
    # Interval for cleaning up expired entries from the metrics cache.
    PROMETHEUS_METRICS_CACHE_CLEANUP_INTERVAL: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.cleanupInterval | default "1m" | quote }}{{ else }}"1m"{{ end }}
    # Interval for background refresh of metrics cache entries.
    PROMETHEUS_METRICS_CACHE_FETCH_INTERVAL: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.fetchInterval | default "30s" | quote }}{{ else }}"30s"{{ end }}
    # Maximum age for metrics to be considered fresh.
    PROMETHEUS_METRICS_CACHE_FRESH_THRESHOLD: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.freshThreshold | default "1m" | quote }}{{ else }}"1m"{{ end }}
    # Maximum age for metrics to be considered stale (before unavailable).
    PROMETHEUS_METRICS_CACHE_STALE_THRESHOLD: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.staleThreshold | default "2m" | quote }}{{ else }}"2m"{{ end }}
    # Maximum age for metrics before they are considered unavailable.
    PROMETHEUS_METRICS_CACHE_UNAVAILABLE_THRESHOLD: {{ if and .Values.wva.prometheus .Values.wva.prometheus.metricsCache }}{{ .Values.wva.prometheus.metricsCache.unavailableThreshold | default "5m" | quote }}{{ else }}"5m"{{ end }}
{{- end }}
